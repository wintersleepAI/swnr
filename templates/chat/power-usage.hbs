<div class="chat-card power-usage">
  <h3 title="{{ power.system.description }}">{{ power.name }}</h3>

  {{! Show resource costs if resources were spent }}
  {{#if consumptions}}
    <div class="resource-cost">
      {{#if strainCost}}
        <span class="strain-cost">
          <i class="fas fa-bolt"></i>
          {{strainCost}} System Strain
        </span>
      {{/if}}
      {{#each consumptions}}
        {{#unless (eq type "systemStrain")}}
          <span class="consumption-cost consumption-{{type}}">
            <i class="fas fa-circle-minus"></i>
            {{#if (eq type "uses")}}
              {{spent}} {{localize "swnr.consumption.uses"}} {{#if cadence}}
                {{#if (eq cadence "day")}}{{localize 'swnr.effort.dayShort'}}
                {{else if (eq cadence "scene")}}{{localize 'swnr.effort.sceneShort'}}
                {{else}}{{localize 'swnr.effort.commitShort'}}
                {{/if}}
              {{/if}}
            {{else if (eq type "consumableItem")}}
              {{spent}} {{localize "swnr.consumption.consumableItem"}}
              {{#if items}}
                :
                {{#each items}}
                  {{itemName}} Ã— {{amount}}{{#unless @last}}, {{/unless}}
                {{/each}}
              {{/if}}
            {{else}}
              {{spent}} {{resourceName}}{{#if subResource}}:{{subResource}}{{/if}} {{#if cadence}}
                {{#if (eq cadence "day")}}{{localize 'swnr.effort.dayShort'}}
                {{else if (eq cadence "scene")}}{{localize 'swnr.effort.sceneShort'}}
                {{else}}{{localize 'swnr.effort.commitShort'}}
                {{/if}}
              {{/if}}
            {{/if}}
          </span>
        {{/unless}}
      {{/each}}
    </div>
  {{/if}}

  <div class="chat-desc">
    {{#if (wouldTrim power.system.description 200)}}
      <span class="hiddenShort">
        {{{trim power.system.description 200}}}
        <div class="border border-gray-700 placeholder-blue-800 pt-0">
          <button class="longShowDesc">{{localize "swnr.sheet.showLongDesc"}}</button>
        </div>
      </span>
      <div class="border border-gray-700 placeholder-blue-800 pt-0">
        <span style="display:none" class="hiddenLong">
        {{{ power.system.description }}}
        <button class="longHideDesc">{{localize "swnr.sheet.hideLongDesc"}}</button>
        </span>
      </div>
    {{else}}
      <span>
        {{{power.system.description }}}
      </span>
    {{/if}}
  </div>

  {{#if power.system.range}}
      <div>
        {{localize 'swnr.sheet.powers.range'}}: {{ power.system.range }}
      </div>
  {{/if}}

  {{#if power.system.duration}}
      <div>
        {{localize 'swnr.sheet.powers.duration'}}: {{ power.system.duration }}
      </div>
  {{/if}}

  {{#if power.system.level}}
      <div>
        {{localize 'swnr.sheet.powers.level'}}: {{ power.system.level }}
      </div>
  {{/if}}

  {{#if power.system.roll}}
    <div class="power-roll">
      <span>{{localize 'swnr.sheet.powers.roll'}}:</span>
      <span class="roll roll-damage">{{{ powerRoll }}}</span>
    </div>
  {{/if}}

  {{#if power.system.save}}
  <div class="card-buttons">
      <button data-action="save" data-save="{{power.system.save}}">
          {{localize "swnr.sheet.powers.save"}} {{power.system.save}}
      </button>
  </div>
  {{/if}}

  {{#if power.system.skill}}
  <div class="card-buttons">
      <button data-action="skill" data-skill="{{power.system.skill}}">
          {{power.system.skill}}
      </button>
  </div>
  {{/if}}

  {{#if isPassive}}
    <div class="passive-indicator">
      <i class="fas fa-info-circle"></i>
      <span>{{localize "swnr.sheet.passive"}}</span>
    </div>
  {{else}}
    <div class="card-buttons resource-management">
      {{! Show recovery buttons for already processed consumptions }}
      {{#if strainCost}}
        <button data-action="recover-strain" data-amount="{{strainCost}}" data-actor-id="{{actor.id}}">
          <i class="fas fa-heart"></i>
          {{localize "swnr.consumption.recoverStrain"}} {{strainCost}}
        </button>
      {{/if}}

      {{! Show consumption buttons for unprocessed manual consumptions only (timing: "manual") }}
      {{#each power.system.consumptions}}
        {{#if (and (ne type "none") (eq timing "manual"))}}
          {{! Check if this consumption has already been processed }}
          {{#unless (lookup ../processedConsumptions @index)}}
            <button data-action="use-consumption" data-power-id="{{../power.id}}" data-actor-id="{{../actor.id}}" data-consumption-index="{{@index}}">
              {{#if (eq type "poolResource")}}
                <i class="fas fa-battery-half"></i>
                Spend {{usesCost}} {{resourceName}}{{#if subResource}}:{{subResource}}{{/if}} {{#if cadence}}
                  {{#if (eq cadence "day")}}{{localize 'swnr.effort.dayShort'}}
                  {{else if (eq cadence "scene")}}{{localize 'swnr.effort.sceneShort'}}
                  {{else}}{{localize 'swnr.effort.commitShort'}}
                  {{/if}}
                {{/if}}
              {{else if (eq type "systemStrain")}}
                <i class="fas fa-heart-broken"></i>
                Take {{usesCost}} {{localize "swnr.consumption.systemStrain"}}
              {{else if (eq type "uses")}}
                <i class="fas fa-minus-circle"></i>
                Use {{usesCost}} {{localize "swnr.consumption.uses"}} {{#if cadence}}
                  {{#if (eq cadence "day")}}{{localize 'swnr.effort.dayShort'}}
                  {{else if (eq cadence "scene")}}{{localize 'swnr.effort.sceneShort'}}
                  {{else}}{{localize 'swnr.effort.commitShort'}}
                  {{/if}}
                {{/if}}
              {{else if (eq type "consumableItem")}}
                <i class="fas fa-cube"></i>
                Consume {{usesCost}} {{localize "swnr.consumption.consumableItem"}}
              {{/if}}
            </button>
          {{/unless}}
        {{/if}}
      {{/each}}
    </div>
  {{/if}}
</div>
